# Dev CI/CD Pipeline - Docker Hub & Argo CD
# Triggers on push to dev branch
# Builds, pushes to Docker Hub, updates values, runs tests, and creates PR to main if successful

name: Dev Docker Hub CI

on:
  push:
    branches: [dev]

# Prevent concurrent deployments on the same branch
concurrency:
  group: dev-ci
  cancel-in-progress: true

# Minimal permissions by default
permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write

j
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set SHORT_SHA
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Login to Docker Hub
        run: docker login -u "${{ secrets.DOCKER_USERNAME }}" -p "${{ secrets.DOCKER_ACCSES_KEY }}"

      - name: Build backend (latest + sha)
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/quiz-ai-backend:latest \
                       -t ${{ secrets.DOCKER_USERNAME }}/quiz-ai-backend:${SHORT_SHA} ./Backend

      - name: Build frontend (latest + sha)
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/quiz-ai-frontend:latest \
                       -t ${{ secrets.DOCKER_USERNAME }}/quiz-ai-frontend:${SHORT_SHA} ./Frontend

      - name: Push backend
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/quiz-ai-backend:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/quiz-ai-backend:${SHORT_SHA}

      - name: Push frontend
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/quiz-ai-frontend:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/quiz-ai-frontend:${SHORT_SHA}


  # Job 3: Update Helm values for dev environment
  update-values-dev:
    name: Update dev values
    runs-on: ubuntu-latest
    needs: [meta, build-and-push-dockerhub]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      
      # Check if manifests are in another repo
      - name: Checkout manifests repo (if different)
        if: ${{ secrets.MANIFESTS_REPO != '' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.MANIFESTS_REPO }}
          ref: ${{ secrets.MANIFESTS_REPO_BRANCH || 'main' }}
          path: manifests
          token: ${{ secrets.GH_TOKEN }}
      
      - name: Install yq
        uses: mikefarah/yq@master
      
      # Update values in same repo
      - name: Update values in same repo
        if: ${{ secrets.MANIFESTS_REPO == '' }}
        run: |
          # Update backend values
          if [ -n "${{ secrets.DEV_VALUES_FILE_BACKEND }}" ]; then
            export REPO="${{ needs.meta.outputs.backend_image_dh }}"
            export TAG="${{ needs.meta.outputs.sha7 }}"
            yq -i '.image.repository = env(REPO) | .image.tag = env(TAG)' ${{ secrets.DEV_VALUES_FILE_BACKEND }}
          fi
          
          # Update frontend values
          if [ -n "${{ secrets.DEV_VALUES_FILE_FRONTEND }}" ]; then
            export REPO="${{ needs.meta.outputs.frontend_image_dh }}"
            export TAG="${{ needs.meta.outputs.sha7 }}"
            yq -i '.image.repository = env(REPO) | .image.tag = env(TAG)' ${{ secrets.DEV_VALUES_FILE_FRONTEND }}
          fi
          
          # Commit and push
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore(dev): update images to ${{ needs.meta.outputs.sha7 }}"
          git push origin dev
      
      # Update values in different repo
      - name: Update values in different repo
        if: ${{ secrets.MANIFESTS_REPO != '' }}
        working-directory: manifests
        run: |
          # Create and checkout branch
          BRANCH_NAME="auto/dev-image-bump-${{ needs.meta.outputs.sha7 }}"
          git checkout -b $BRANCH_NAME
          
          # Update backend values
          if [ -n "${{ secrets.DEV_VALUES_FILE_BACKEND }}" ]; then
            export REPO="${{ needs.meta.outputs.backend_image_dh }}"
            export TAG="${{ needs.meta.outputs.sha7 }}"
            yq -i '.image.repository = env(REPO) | .image.tag = env(TAG)' ${{ secrets.DEV_VALUES_FILE_BACKEND }}
          fi
          
          # Update frontend values
          if [ -n "${{ secrets.DEV_VALUES_FILE_FRONTEND }}" ]; then
            export REPO="${{ needs.meta.outputs.frontend_image_dh }}"
            export TAG="${{ needs.meta.outputs.sha7 }}"
            yq -i '.image.repository = env(REPO) | .image.tag = env(TAG)' ${{ secrets.DEV_VALUES_FILE_FRONTEND }}
          fi
          
          # Commit and push
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore(dev): bump images to ${{ needs.meta.outputs.sha7 }}"
          git push origin $BRANCH_NAME
          
          # Create PR
          gh pr create \
            --title "chore(dev): bump images to ${{ needs.meta.outputs.sha7 }}" \
            --body "## Image Updates
            
            ### Backend
            - Repository: \`${{ needs.meta.outputs.backend_image_dh }}\`
            - Old Tag: \`latest\`
            - New Tag: \`${{ needs.meta.outputs.sha7 }}\`
            
            ### Frontend
            - Repository: \`${{ needs.meta.outputs.frontend_image_dh }}\`
            - Old Tag: \`latest\`
            - New Tag: \`${{ needs.meta.outputs.sha7 }}\`" \
            --base ${{ secrets.MANIFESTS_REPO_BRANCH || 'main' }} \
            --head $BRANCH_NAME
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  # Job 4: Notify Argo CD for dev apps
  notify-argocd-dev:
    name: Notify Argo CD Dev
    runs-on: ubuntu-latest
    needs: update-values-dev
    if: ${{ secrets.ARGOCD_SERVER != '' && secrets.ARGOCD_AUTH_TOKEN != '' }}
    steps:
      - name: Refresh and sync Argo CD apps
        shell: bash
        run: |
          # Set curl options based on ARGOCD_INSECURE
          CURL_OPTS=""
          if [ "${{ secrets.ARGOCD_INSECURE }}" == "true" ]; then
            CURL_OPTS="-k"
          fi
          
          # Process each app in ARGOCD_DEV_APPS
          IFS=',' read -ra APPS <<< "${{ secrets.ARGOCD_DEV_APPS }}"
          for app in "${APPS[@]}"; do
            app=$(echo "$app" | xargs) # Trim whitespace
            echo "Processing app: $app"
            
            # Refresh the app
            echo "Refreshing app: $app"
            curl $CURL_OPTS -X POST \
              -H "Authorization: Bearer ${{ secrets.ARGOCD_AUTH_TOKEN }}" \
              -H "Content-Type: application/json" \
              "https://${{ secrets.ARGOCD_SERVER }}/api/v1/applications/${app}/resource-tree?refresh=true"
            
            # Sync the app
            echo "Syncing app: $app"
            curl $CURL_OPTS -X POST \
              -H "Authorization: Bearer ${{ secrets.ARGOCD_AUTH_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"prune": true, "dryRun": false}' \
              "https://${{ secrets.ARGOCD_SERVER }}/api/v1/applications/${app}/sync"
            
            echo "Completed processing for app: $app"
          done

  # Job 5: Comment on commit
  comment-tests-started:
    name: Comment tests started
    runs-on: ubuntu-latest
    needs: [meta, notify-argocd-dev]
    steps:
      - name: Create commit comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || github.token }}
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `ðŸš€ **Dev CI**: Tests running for commit \`${context.sha.substring(0, 7)}\`...`
            });

  # Job 6: Run tests
  tests:
    name: Run tests
    runs-on: ubuntu-latest
    needs: comment-tests-started
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Backend tests
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install backend dependencies
        run: |
          pip install -r Backend/requirements.txt
      
      - name: Run backend tests
        run: |
          cd Backend
          pytest || echo "Backend tests placeholder - replace with actual tests"
      
      # Frontend tests
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install frontend dependencies
        run: |
          npm ci --prefix Frontend
      
      - name: Run frontend tests
        run: |
          npm test --prefix Frontend -- --ci || echo "Frontend tests placeholder - replace with actual tests"

  # Job 7: Send email on failure
  email-on-failure:
    name: Email on failure
    runs-on: ubuntu-latest
    needs: [meta, tests]
    if: failure()
    steps:
      - name: Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "Dev CI failed for ${{ needs.meta.outputs.sha7 }}"
          to: ilay.elimelech2@gmail.com
          from: ${{ secrets.GMAIL_USERNAME }}
          body: |
            The Dev CI pipeline has failed for commit ${{ needs.meta.outputs.sha7 }}.
            
            View the failed run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Repository: ${{ github.repository }}
            Branch: dev
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}

  # Job 8: Create PR to main on success
  auto-pr-to-main:
    name: Create PR to main
    runs-on: ubuntu-latest
    needs: [meta, build-and-push-dockerhub, tests]
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      
      - name: Create PR to main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const sha7 = '${{ needs.meta.outputs.sha7 }}';
            const backendImage = '${{ needs.meta.outputs.backend_image_dh }}';
            const frontendImage = '${{ needs.meta.outputs.frontend_image_dh }}';
            
            let body = `## Promotion to Production
            
            âœ… **Tests passed**
            
            ### Images to promote:
            
            #### Backend
            - Image: \`${backendImage}:${sha7}\`
            - Tags: \`latest\`, \`${sha7}\`
            
            #### Frontend
            - Image: \`${frontendImage}:${sha7}\`
            - Tags: \`latest\`, \`${sha7}\`
            
            ### Commit details:
            - SHA: \`${{ github.sha }}\`
            - Author: @${{ github.actor }}`;
            
            // Add link to manifests PR if it exists
            if ('${{ secrets.MANIFESTS_REPO }}' !== '') {
              body += `\n\n### Related PRs:\n- Manifests update: See PR in ${{ secrets.MANIFESTS_REPO }}`;
            }
            
            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ci(dev): promote ${sha7} to main`,
                head: 'dev',
                base: 'main',
                body: body
              });
              
              console.log(`Created PR #${pr.data.number}`);
            } catch (error) {
              console.log('PR may already exist or cannot be created:', error.message);
            }
